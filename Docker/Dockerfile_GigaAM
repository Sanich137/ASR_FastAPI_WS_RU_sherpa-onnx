# Базовый образ с CUDA и cuDNN
FROM nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04

# Установка зависимостей
RUN apt-get update && apt-get install -y \
    git \
    git-lfs \
    portaudio19-dev \
    python3-pyaudio \
    ffmpeg \
    python3-pip \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*  # Очистка кеша apt

RUN git lfs install

# Собираем модели для ASR
RUN mkdir "temp_models" && \
    cd temp_models && \
    git clone https://huggingface.co/Alexanrd/GigaAMv2_CTC_RU_ASR_for_sherpa_onnx && \
    git clone https://huggingface.co/Alexanrd/sbert_punc_case_ru_onnx && \
    cd ..

# Устанавливаем основное приложени
RUN  --mount=type=ssh git clone https://github.com/Sanich137/ASR_FastAPI_WS_RU_sherpa-onnx


# Собираем модели для VAD
RUN mkdir -p temp_models/VAD_silero_v5
RUN curl -L https://github.com/snakers4/silero-vad/raw/v5.0/files/silero_vad.onnx \
         -o temp_models/VAD_silero_v5/silero_vad.onnx
RUN test -f temp_models/VAD_silero_v5/silero_vad.onnx || (echo "File download failed!" && exit 1)


# Переносим модели
RUN rm -rf ASR_FastAPI_WS_RU_sherpa-onnx/models && \
    mkdir -p ASR_FastAPI_WS_RU_sherpa-onnx/models && \
    mv temp_models/* ASR_FastAPI_WS_RU_sherpa-onnx/models/ && \
    rm -rf temp_models

WORKDIR /ASR_FastAPI_WS_RU_sherpa-onnx

# Установка Python-зависимостей
RUN pip install --no-cache-dir -r requirements.txt

# Установка переменных окружения
ENV BASE_SAMPLE_RATE=16000 \
    CAN_DIAR=1 \
    DIAR_MODEL_NAME=voxceleb_gemini_dfresnet114_LM \
    DIAR_WITH_GPU=1 \
    IS_PROD=1 \
    LOGGING_LEVEL=INFO \
    MAX_OVERLAP_DURATION=25 \
    MODEL_NAME=Gigaam\
    NUM_THREADS=4 \
    PROVIDER=CUDA \
    VAD_SENSE=3

# Открываем порт и запускаем приложение
EXPOSE 49153
CMD ["python3", "main.py"]